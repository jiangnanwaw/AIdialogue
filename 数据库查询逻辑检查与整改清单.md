# 数据库查询逻辑检查与整改清单

## 一、项目概述

本项目是一个AI对话系统，支持通过自然语言查询SQL Server数据库。系统包含18个数据表，支持多种查询类型。

## 二、现有查询类型支持情况

### 2.1 已支持的查询类型

#### 基础查询
- ✅ 最高、最低、最多、最少
- ✅ 每年、每月、每天
- ✅ 平均每天、平均每月、平均每年
- ✅ 哪一天、哪一月、哪一年
- ✅ 最高的多少天、最高的多少月、最高的哪一年
- ✅ 最多的哪一天、最少的哪一天
- ✅ 最高的哪一月、最低的哪一月

#### 对比查询
- ✅ 年度对比（如"2025年对比2024年"）
- ✅ 月度对比（如"2025年11月对比2024年11月"）
- ✅ 平均值对比

#### 排名查询
- ✅ 按车牌排名（TOP N）
- ✅ 按日期排名（TOP N天）
- ✅ 按设备排名（枪/终端）

#### 特殊查询
- ✅ 毛利润计算（充电收入 - 电力局电费）
- ✅ 电量损耗计算（电力局电量 - 充电电量）
- ✅ 综合业务收入查询
- ✅ 停车收入查询
- ✅ 明细查询

### 2.2 缺失的查询类型

#### 1. 季度查询（Q1/Q2/Q3/Q4）
**问题描述：** 用户指南中提到支持季度查询，但代码中未实现
- ❌ 季度统计（如"2025年Q1收入"）
- ❌ 季度对比（如"2025年Q1对比2024年Q1"）
- ❌ 哪一季度最多/最少
- ❌ 平均每季度

**影响：** 用户指南中提到的季度查询功能无法使用

#### 2. 增长率/百分比查询
**问题描述：** 代码注释明确说明"不计算增长率百分比"，但这是重要功能
- ❌ 同比增长率（如"2025年对比2024年增长率"）
- ❌ 环比增长率（如"2025年11月对比10月增长率"）
- ❌ 百分比占比（如"特来电收入占总收入的比例"）
- ❌ 增长率排名

**影响：** 无法进行趋势分析和占比分析

#### 3. 累计查询
**问题描述：** 缺少累计统计功能
- ❌ 累计收入（如"2025年累计收入"）
- ❌ 累计电量（如"2025年累计充电电量"）
- ❌ 累计增长率
- ❌ 累计对比

**影响：** 无法进行累计数据分析

#### 4. 周查询
**问题描述：** 缺少周维度查询
- ❌ 每周统计（如"2025年第1周收入"）
- ❌ 平均每周（如"2025年平均每周收入"）
- ❌ 哪一周最多/最少
- ❌ 周对比（如"本周对比上周"）

**影响：** 无法进行周维度分析

#### 5. 时间段范围查询
**问题描述：** 缺少灵活的时间段查询
- ❌ 多月份范围（如"2025年1-3月收入"）
- ❌ 多季度范围（如"2025年Q1-Q2收入"）
- ❌ 自定义日期范围（如"2025年1月1日至3月31日"）
- ❌ 跨年查询（如"2024年12月至2025年2月"）

**影响：** 无法进行灵活的时间段分析

#### 6. 趋势分析查询
**问题描述：** 用户指南中提到趋势分析，但实现不完整
- ❌ 增长趋势（如"2025年收入增长趋势"）
- ❌ 下降趋势（如"2025年收入下降趋势"）
- ❌ 趋势预测（基于历史数据）
- ❌ 趋势对比（如"收入趋势对比电量趋势"）

**影响：** 无法进行趋势分析

#### 7. 异常值查询
**问题描述：** 缺少异常值检测功能
- ❌ 超过平均值的日期（如"收入超过平均值的日期"）
- ❌ 低于平均值的日期（如"收入低于平均值的日期"）
- ❌ 异常波动检测（如"收入波动超过20%的日期"）
- ❌ 极值查询（如"收入最高的10天和最低的10天"）

**影响：** 无法进行异常值分析

#### 8. 分布查询
**问题描述：** 缺少数据分布分析
- ❌ 收入分布（如"收入在1000-2000元之间的天数"）
- ❌ 电量分布（如"电量在100-200度之间的订单数"）
- ❌ 时间段分布（如"收入在上午、下午、晚上的分布"）
- ❌ 设备分布（如"各充电枪的收入分布"）

**影响：** 无法进行数据分布分析

#### 9. 聚合统计查询
**问题描述：** 缺少综合统计功能
- ❌ 最大值、最小值、平均值、中位数（一次性查询）
- ❌ 标准差、方差
- ❌ 分位数（如"收入的中位数"）
- ❌ 统计摘要（如"2025年收入统计摘要"）

**影响：** 无法进行综合统计分析

#### 10. 多维度组合查询
**问题描述：** 部分多维度查询支持不完整
- ⚠️ 按表+时间维度（如"2025年四方坪特来电每月收入"）
- ⚠️ 按地点+时间维度（如"四方坪和高岭每月收入对比"）
- ⚠️ 按表+地点+时间维度（如"2025年四方坪特来电和能科每月收入对比"）
- ❌ 按设备+时间维度（如"2025年每把枪每月收入"）

**影响：** 多维度分析能力有限

#### 11. 同比/环比查询
**问题描述：** 缺少标准的同比环比查询
- ❌ 同比查询（如"2025年11月同比2024年11月"）
- ❌ 环比查询（如"2025年11月环比10月"）
- ❌ 同比环比增长率
- ❌ 同比环比趋势

**影响：** 无法进行标准的同比环比分析

#### 12. 排名扩展查询
**问题描述：** 排名查询功能可以扩展
- ⚠️ 排名百分比（如"前10%的收入"）
- ⚠️ 排名区间（如"排名11-20的车牌"）
- ❌ 排名变化（如"2025年对比2024年排名变化"）
- ❌ 排名趋势（如"某车牌排名变化趋势"）

**影响：** 排名分析功能不够丰富

## 三、数据库表字段配置检查

### 3.1 表字段配置完整性检查

#### 特来电表 ✅
- ✅ 时间字段：充电结束时间
- ✅ 电量字段：充电电量(度)
- ✅ 收入字段：充电费用(元)、充电服务费(元)、充电电费(元)
- ✅ 设备字段：电站名称、终端名称
- ✅ 车牌字段：判定车牌号
- ✅ 时长字段：充电时长(分钟)

#### 能科表 ✅
- ✅ 时间字段：结束日期时间
- ✅ 电量字段：充电量
- ✅ 收入字段：消费金额、服务费、电费
- ✅ 设备字段：充电桩名称
- ✅ 时长字段：充电时长（需要转换）

#### 滴滴表 ✅
- ✅ 时间字段：充电完成时间
- ✅ 电量字段：充电量（度）（需要转换）
- ✅ 收入字段：订单总额（元）、充电服务费（元）、充电电费（元）（需要转换）
- ✅ 设备字段：场站名称、充电枪ID
- ✅ 车牌字段：车牌号
- ✅ 时长字段：充电时长（分钟）

#### 车海洋洗车充值表 ✅
- ✅ 时间字段：时间
- ✅ 收入字段：返还金额

#### 车海洋洗车消费表 ✅
- ✅ 时间字段：时间
- ✅ 收入字段：返还金额（只检查非空，不检查>0）

#### 车颜知己洗车表 ✅
- ✅ 时间字段：启动时间
- ✅ 收入字段：订单金额（需要条件判断：使用会员卡=否且订单状态=已完成，或使用会员卡=是且订单状态=已完成）

#### 电力局表 ✅
- ✅ 时间字段：年、月（特殊处理）
- ✅ 电量字段：电量
- ✅ 电费字段：购电费+输配电量电费+力调电费+基金及附加+上网线损费用+系统运行费用+环境价值费用
- ✅ 地点字段：变压器编号

#### 红门缴费表 ✅
- ✅ 时间字段：缴费时间
- ✅ 收入字段：交易金额
- ✅ 车牌字段：收费车牌

#### 快易洁洗车表 ✅
- ✅ 时间字段：日期
- ✅ 收入字段：返还总额

#### 赛菲姆道闸表 ✅
- ✅ 时间字段：支付时间
- ✅ 收入字段：支付金额
- ✅ 支付方式字段：支付方式（用于过滤线下现金、平台现金）

#### 收钱吧表 ✅
- ✅ 时间字段：交易日期
- ✅ 收入字段：实收金额
- ✅ 状态字段：交易状态（用于过滤）

#### 兴元售货机表 ✅
- ✅ 时间字段：支付时间
- ✅ 收入字段：支付金额-退款金额

#### 微信商户下单表 ✅
- ✅ 时间字段：交易时间
- ✅ 收入字段：订单金额-退款金额（需要转换）

#### 微信收款商业版表 ✅
- ✅ 时间字段：交易时间
- ✅ 收入字段：订单金额-退款金额（需要转换）

#### 月租车充值表 ✅
- ✅ 时间字段：交款时间
- ✅ 收入字段：交款金额
- ✅ 车牌字段：车牌号码

#### 智小盟表 ✅
- ✅ 时间字段：支付时间
- ✅ 收入字段：实收金额

#### 超时占位费表 ✅
- ✅ 时间字段：支付时间
- ✅ 收入字段：应收金额（需要转换）

#### 活动优惠券表 ✅
- ✅ 时间字段：收款时间
- ✅ 收入字段：特殊计算逻辑
- ✅ 地点字段：电站名称

### 3.2 字段配置问题

#### 问题1：缺少部分字段的查询支持
- ⚠️ 充电开始时间（特来电表）：未在字段配置中，但可能有用
- ⚠️ 订单编号（特来电表）：已配置为count类型，但缺少详细查询
- ⚠️ 卡号（能科表）：已配置为count类型，但缺少详细查询
- ⚠️ 支付方式（赛菲姆道闸表）：已配置，但缺少按支付方式分组查询
- ⚠️ 交易状态（收钱吧表）：已配置，但缺少按状态分组查询

#### 问题2：缺少部分表的字段配置
- ❌ 缺少"滴滴"表的完整字段配置检查（虽然代码中有，但需要确认完整性）

## 四、查询逻辑检查

### 4.1 时间过滤规则 ✅
- ✅ 能科表：2024年5月（含）以后没有数据
- ✅ 特来电表：2026年2月（含）以后没有数据
- ✅ 滴滴表：2025年11月（含）之前没有数据
- ✅ 时间过滤规则已正确实现

### 4.2 地点筛选规则 ✅
- ✅ 四方坪：排除高岭电站
- ✅ 高岭：只查询高岭电站
- ✅ 电力局变压器编号匹配正确

### 4.3 空值处理 ✅
- ✅ 所有查询都过滤空值、0值和空字符串
- ✅ 特殊处理：车海洋洗车消费表的返还金额只检查非空

### 4.4 数据类型转换 ✅
- ✅ 微信表：订单金额和退款金额需要CAST转换
- ✅ 超时占位费表：应收金额需要CAST转换
- ✅ 滴滴表：充电量、订单总额等需要CAST转换

### 4.5 性能优化 ✅
- ✅ 使用日期范围而不是YEAR()函数
- ✅ 避免复杂的CROSS JOIN
- ✅ 使用ISNULL处理NULL值

## 五、整改清单

### 5.1 高优先级整改项

#### 1. 实现季度查询功能
**优先级：** 高
**原因：** 用户指南中已提到，但代码未实现
**任务：**
- [ ] 在extractTimeInfo函数中添加季度识别（Q1/Q2/Q3/Q4）
- [ ] 在generateSQLByRules函数中添加季度查询逻辑
- [ ] 在AI提示词中添加季度查询示例
- [ ] 测试季度查询功能

#### 2. 实现增长率/百分比查询
**优先级：** 高
**原因：** 这是重要的分析功能
**任务：**
- [ ] 实现同比增长率计算
- [ ] 实现环比增长率计算
- [ ] 实现百分比占比计算
- [ ] 在AI提示词中添加增长率查询示例
- [ ] 测试增长率查询功能

#### 3. 实现累计查询功能
**优先级：** 高
**原因：** 累计数据是重要的业务指标
**任务：**
- [ ] 实现累计收入查询
- [ ] 实现累计电量查询
- [ ] 实现累计增长率查询
- [ ] 在AI提示词中添加累计查询示例
- [ ] 测试累计查询功能

#### 4. 实现周查询功能
**优先级：** 中
**原因：** 周维度分析是常见需求
**任务：**
- [ ] 在extractTimeInfo函数中添加周识别
- [ ] 实现周统计查询
- [ ] 实现平均每周查询
- [ ] 实现周对比查询
- [ ] 在AI提示词中添加周查询示例
- [ ] 测试周查询功能

#### 5. 实现时间段范围查询
**优先级：** 中
**原因：** 灵活的时间段查询是重要功能
**任务：**
- [ ] 在extractTimeInfo函数中添加多月份范围识别（如"1-3月"）
- [ ] 在extractTimeInfo函数中添加多季度范围识别（如"Q1-Q2"）
- [ ] 在extractTimeInfo函数中添加自定义日期范围识别（如"1月1日至3月31日"）
- [ ] 实现跨年查询
- [ ] 在AI提示词中添加时间段范围查询示例
- [ ] 测试时间段范围查询功能

### 5.2 中优先级整改项

#### 6. 完善趋势分析查询
**优先级：** 中
**原因：** 用户指南中已提到，但实现不完整
**任务：**
- [ ] 实现增长趋势查询
- [ ] 实现下降趋势查询
- [ ] 实现趋势对比查询
- [ ] 在AI提示词中添加趋势分析查询示例
- [ ] 测试趋势分析查询功能

#### 7. 实现异常值查询
**优先级：** 中
**原因：** 异常值分析有助于发现业务问题
**任务：**
- [ ] 实现超过平均值的日期查询
- [ ] 实现低于平均值的日期查询
- [ ] 实现异常波动检测
- [ ] 实现极值查询
- [ ] 在AI提示词中添加异常值查询示例
- [ ] 测试异常值查询功能

#### 8. 实现分布查询
**优先级：** 中
**原因：** 数据分布分析有助于了解业务特征
**任务：**
- [ ] 实现收入分布查询
- [ ] 实现电量分布查询
- [ ] 实现时间段分布查询
- [ ] 实现设备分布查询
- [ ] 在AI提示词中添加分布查询示例
- [ ] 测试分布查询功能

#### 9. 实现聚合统计查询
**优先级：** 中
**原因：** 综合统计有助于快速了解数据特征
**任务：**
- [ ] 实现最大值、最小值、平均值、中位数一次性查询
- [ ] 实现标准差、方差查询
- [ ] 实现分位数查询
- [ ] 实现统计摘要查询
- [ ] 在AI提示词中添加聚合统计查询示例
- [ ] 测试聚合统计查询功能

#### 10. 完善多维度组合查询
**优先级：** 中
**原因：** 多维度分析是高级分析需求
**任务：**
- [ ] 完善按表+时间维度查询
- [ ] 完善按地点+时间维度查询
- [ ] 完善按表+地点+时间维度查询
- [ ] 实现按设备+时间维度查询
- [ ] 在AI提示词中添加多维度查询示例
- [ ] 测试多维度查询功能

### 5.3 低优先级整改项

#### 11. 实现同比/环比查询
**优先级：** 低
**原因：** 已有对比查询，但缺少标准的同比环比
**任务：**
- [ ] 实现同比查询（自动识别去年同期）
- [ ] 实现环比查询（自动识别上期）
- [ ] 实现同比环比增长率
- [ ] 实现同比环比趋势
- [ ] 在AI提示词中添加同比环比查询示例
- [ ] 测试同比环比查询功能

#### 12. 扩展排名查询功能
**优先级：** 低
**原因：** 现有排名功能已满足基本需求
**任务：**
- [ ] 实现排名百分比查询
- [ ] 实现排名区间查询
- [ ] 实现排名变化查询
- [ ] 实现排名趋势查询
- [ ] 在AI提示词中添加排名扩展查询示例
- [ ] 测试排名扩展查询功能

#### 13. 完善字段配置
**优先级：** 低
**原因：** 现有字段配置已基本完整
**任务：**
- [ ] 添加充电开始时间字段支持
- [ ] 完善订单编号详细查询
- [ ] 完善卡号详细查询
- [ ] 实现按支付方式分组查询
- [ ] 实现按交易状态分组查询
- [ ] 确认滴滴表字段配置完整性

## 六、任务清单

### 6.1 第一阶段任务（高优先级）

1. **季度查询功能开发**
   - 预计工作量：2天
   - 负责人：开发团队
   - 依赖：无

2. **增长率/百分比查询功能开发**
   - 预计工作量：3天
   - 负责人：开发团队
   - 依赖：无

3. **累计查询功能开发**
   - 预计工作量：2天
   - 负责人：开发团队
   - 依赖：无

4. **周查询功能开发**
   - 预计工作量：2天
   - 负责人：开发团队
   - 依赖：无

5. **时间段范围查询功能开发**
   - 预计工作量：3天
   - 负责人：开发团队
   - 依赖：无

**第一阶段总工作量：** 12天

### 6.2 第二阶段任务（中优先级）

6. **趋势分析查询功能完善**
   - 预计工作量：2天
   - 负责人：开发团队
   - 依赖：第一阶段完成

7. **异常值查询功能开发**
   - 预计工作量：2天
   - 负责人：开发团队
   - 依赖：第一阶段完成

8. **分布查询功能开发**
   - 预计工作量：3天
   - 负责人：开发团队
   - 依赖：第一阶段完成

9. **聚合统计查询功能开发**
   - 预计工作量：2天
   - 负责人：开发团队
   - 依赖：第一阶段完成

10. **多维度组合查询功能完善**
    - 预计工作量：3天
    - 负责人：开发团队
    - 依赖：第一阶段完成

**第二阶段总工作量：** 12天

### 6.3 第三阶段任务（低优先级）

11. **同比/环比查询功能开发**
    - 预计工作量：2天
    - 负责人：开发团队
    - 依赖：第二阶段完成

12. **排名扩展查询功能开发**
    - 预计工作量：2天
    - 负责人：开发团队
    - 依赖：第二阶段完成

13. **字段配置完善**
    - 预计工作量：1天
    - 负责人：开发团队
    - 依赖：无

**第三阶段总工作量：** 5天

### 6.4 测试任务

14. **功能测试**
    - 预计工作量：5天
    - 负责人：测试团队
    - 依赖：各阶段功能开发完成

15. **性能测试**
    - 预计工作量：2天
    - 负责人：测试团队
    - 依赖：功能测试完成

16. **用户验收测试**
    - 预计工作量：3天
    - 负责人：产品团队
    - 依赖：性能测试完成

**测试总工作量：** 10天

### 6.5 文档更新任务

17. **用户指南更新**
    - 预计工作量：2天
    - 负责人：产品团队
    - 依赖：功能开发完成

18. **技术文档更新**
    - 预计工作量：1天
    - 负责人：开发团队
    - 依赖：功能开发完成

**文档更新总工作量：** 3天

## 七、总结

### 7.1 总体评估

**现有功能完整性：** 70%
- ✅ 基础查询功能完整
- ✅ 对比查询功能完整
- ✅ 排名查询功能完整
- ✅ 特殊计算功能完整（毛利润、电量损耗等）
- ⚠️ 季度查询功能缺失（用户指南中已提到）
- ⚠️ 增长率查询功能缺失
- ⚠️ 累计查询功能缺失
- ⚠️ 周查询功能缺失
- ⚠️ 时间段范围查询功能缺失
- ⚠️ 趋势分析功能不完整
- ⚠️ 异常值查询功能缺失
- ⚠️ 分布查询功能缺失
- ⚠️ 聚合统计查询功能缺失

### 7.2 建议

1. **优先实现高优先级功能**
   - 季度查询、增长率查询、累计查询是用户最需要的功能
   - 建议在第一阶段完成

2. **完善用户指南**
   - 用户指南中提到的功能应该与代码实现保持一致
   - 建议在实现功能后及时更新用户指南

3. **性能优化**
   - 新增功能需要考虑性能影响
   - 建议在开发过程中进行性能测试

4. **测试覆盖**
   - 新增功能需要充分的测试覆盖
   - 建议编写自动化测试用例

### 7.3 预计总工作量

- **开发工作量：** 29天
- **测试工作量：** 10天
- **文档更新工作量：** 3天
- **总计：** 42天（约2个月）

### 7.4 风险提示

1. **性能风险**
   - 新增复杂查询可能影响性能
   - 建议在开发过程中进行性能测试

2. **兼容性风险**
   - 新增功能需要与现有功能兼容
   - 建议进行充分的回归测试

3. **用户体验风险**
   - 新增功能需要用户学习
   - 建议提供清晰的用户指南和示例

---

**文档生成时间：** 2025年1月
**文档版本：** 1.0
**维护人员：** 开发团队




